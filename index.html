<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>NetworkProject ENS</title>

    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
    <script type="text/javascript" src="./node_modules/jquery/dist/jquery.min.js"></script>
    <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="./node_modules/web3/dist/web3.min.js"> </script> </head> <body>
</head>

<body>
    <div class="card m-3">
        <div class="card-header">
            <h5>ENS (NetworkProject Assignment #3)</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="sel_addr">Your Address:</label>
                <select class="form-control" id="sel_addr"></select>
            </div>
            
            <hr>

            <h5 class="card-title">Register Domain</h5>
            <p class="card-text">Register new domain. It requires 0.1 ether.</p>
            <div class="form-group">
                <label for="reg_dname">New Domain Name:</label>
                <input type="text" class="form-control" id="reg_dname">
            </div>
            <div class="form-group">
                <label for="reg_addr">Address to Connect:</label>
                <input type="text" class="form-control" id="reg_addr">
            </div>
            <a id="reg_btn" href="#" class="btn btn-primary">Register</a>
            
            <hr>

            <h5 class="card-title">Query</h5>
            <p class="card-text">Query address / domain name. It requires 0.01 ether. (0.005 to contract, 0.005 to holder)</p>
            
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <button class="btn btn-outline-secondary" type="button" id="query_dname_btn">Search Domain with Address</button>
                </div>
                <input id="query_addr" type="text" class="form-control" placeholder="Enter Address">
            </div>
            <div class="input-group">
                <div class="input-group-prepend">
                    <button class="btn btn-outline-secondary" type="button" id="query_addr_btn">Search Address with Domain</button>
                </div>
                <input id="query_dname" type="text" class="form-control" placeholder="Enter Domain">
            </div>

            <hr>

            <h5 class="card-title">Change Address (Only Domain Owner)</h5>
            <p class="card-text">Change address connected to your domain. It requires 0.1 ether.</p>
            <div class="form-group">
                <label for="change_dname">Domain Name:</label>
                <input type="text" class="form-control" id="change_dname">
            </div>
            <div class="form-group">
                <label for="change_addr">New Address:</label>
                <input type="text" class="form-control" id="change_addr">
            </div>
            <a id="change_btn" href="#" class="btn btn-warning">Change Address</a>

            <hr>

            <h5 class="card-title">Transfer Ownership (Only Domain Owner)</h5>
            <p class="card-text">Transfer ownership of your domain. It requires 0.1 ether.</p>
            <div class="form-group">
                <label for="transfer_dname">Domain Name:</label>
                <input type="text" class="form-control" id="transfer_dname">
            </div>
            <div class="form-group">
                <label for="transfer_onwer">New Owner:</label>
                <input type="text" class="form-control" id="transfer_onwer">
            </div>
            <a id="transfer_btn" href="#" class="btn btn-warning">Transfer Ownership</a>

            <hr>

            <h5 class="card-title">Withdraw (Only Contract Owner)</h5>
            <p class="card-text">Withdraw Ethereum from ENS Contract.</p>
            <div class="form-group">
                <label for="withdraw_amount">Amount (wei):</label>
                <input type="text" class="form-control" id="withdraw_amount">
            </div>
            <a id="withdraw_btn" href="#" class="btn btn-success">Withdraw</a>

            <hr>

            <h5 class="card-title">Destruct (Only Contract Owner)</h5>
            <p class="card-text">Kill Contract.</p>
            <a id="destruct_btn" href="#" class="btn btn-danger">Destruct Contract</a>

        </div>
    </div>
<script>
    let ENS;
    let ENSAddress = '0x1d0a2077bd1f92ca97ccebfd2d6b9b9fdf60afa2';
    window.addEventListener('load', function () {
        if (typeof web3 !== "undefined") web3 = new Web3(web3.currentProvider);
        else {
            alert("No currentProvider Found!");
            console.log("No currentProvider found");
            return;
        }

        // set default Account
        web3.eth.defaultAccount = web3.eth.accounts[0];

        // add address list
        web3.eth.accounts.forEach(function (account) {
            let option = $("<option>" + account + "</option>");
            $('#sel_addr').append(option);
        });

        console.log("web3 address : ", web3.eth.defaultAccount);

        $.getJSON("ENS_ABI.json", function (abi) {
            ENS = web3.eth.contract(abi).at(ENSAddress);
            console.log("Load Contract:", ENS);
        });
    });

    // Select Address
    $("#sel_addr").change(function () {
        web3.eth.defaultAccount = $("#sel_addr option:selected").text();
        console.log("Change address to: ", web3.eth.defaultAccount);
    });

    $("#reg_btn").click(register($('#reg_dname').val(),  $('#reg_addr').val()));
    $("#query_dname_btn").click(query_n2a($('#query_addr').val()));
    $("#query_addr_btn").click(query_a2n($('#query_dname').val()));
    $("#change_btn").click(change_address($('#change_dname').val(), $('#change_addr').val()));
    $("#transfer_btn").click(transfer_owner($('#transfer_dname').val(), $('#transfer_addr').val()));
    $("#withdraw_btn").click(withdraw($('#withdraw_amount').val()));
    $("#destruct_btn").click(destruct());

    // Register
    function register(dname, addr) {
        dname = web3.fromAscii(dname);
        if (!web3.isAddress(addr)) {
            alert("Invalid Address " + addr);
            return;
        }
        ENS.register(dname, addr, {
            from: web3.eth.defaultAccount,
            value: 100000000000000000
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

    // Query (Name => Address)
    function query_n2a(dname) {
        dname = web3.fromAscii(dname);
        ENS.query_n2a(dname, {
            from: web3.eth.defaultAccount,
            value: 10000000000000000
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

    // Query (Address => Name)
    function query_a2n(addr) {
        if (!web3.isAddress(addr)) {
            alert("Invalid Address " + addr);
            return;
        }
        ENS.query_n2a(addr, {
            from: web3.eth.defaultAccount,
            value: 10000000000000000
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

    // Change Address
    function change_address(dname, to_addr) {
        dname = web3.fromAscii(dname);
        if (!web3.isAddress(to_addr)) {
            alert("Invalid Address " + to_addr);
            return;
        }
        ENS.change_address(dname, to_addr, {
            from: web3.eth.defaultAccount,
            value: 100000000000000000
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

    // Transfer Ownership
    function transfer_owner(dname, to_owner) {
        dname = web3.fromAscii(dname);
        if (!web3.isAddress(to_owner)) {
            alert("Invalid Address " + to_owner);
            return;
        }
        ENS.transfer_owner(dname, to_owner, {
            from: web3.eth.defaultAccount,
            value: 100000000000000000
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

    // Withdraw
    function withdraw(amount) {
        ENS.withdraw(amount, {
            from: web3.eth.defaultAccount
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

    // Destruct
    function destruct() {
        ENS.destruct({
            from: web3.eth.defaultAccount
        }, function (err, txHash) {
            if (err) console.log("Error: ", err);
            else console.log("Tx: ", txHash);
        });
    }

</script>
</body>
</html>